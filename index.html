<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Food Calorie Detection</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<style>
body {
font-family: Arial, sans-serif;
text-align: center;
margin: 20px;
}
video, img {
width: 100%;
max-width: 600px;
border: 1px solid black;
margin-bottom: 10px;
}
#controls button {
margin: 5px;
padding: 10px 15px;
font-size: 1em;
}
#calorieResult {
margin-top: 20px;
font-size: 1.2em;
font-weight: bold;
}
</style>
</head>
<body>
<h1>üçé Food Calorie Detection</h1>

<div id="controls">
<button id="startButton">Turn Camera On</button>
<button id="zoomInButton" disabled>Zoom In</button>
<button id="zoomOutButton" disabled>Zoom Out</button>
<button id="captureButton" disabled>Capture Image</button>
<button id="switchViewButton" disabled>Switch to Image</button>
</div>

<video id="video" autoplay></video>
<img id="capturedImage" style="display:none;">
<p id="calorieResult">Loading model, please wait‚Ä¶</p>

<script>
const video = document.getElementById('video');
const capturedImage = document.getElementById('capturedImage');
const calorieResult = document.getElementById('calorieResult');
const startButton = document.getElementById('startButton');
const zoomInButton = document.getElementById('zoomInButton');
const zoomOutButton = document.getElementById('zoomOutButton');
const captureButton = document.getElementById('captureButton');
const switchViewButton = document.getElementById('switchViewButton');

let stream;
let videoStreamActive = false;
let currentView = 'video';
let zoomLevel = 1;
let model;
let modelReady = false;

// --- Small calorie database (expandable) ---
const CAL_DB = [
{ keys: ['pizza'], label: 'Pizza', kcal: 285 },
{ keys: ['hamburger','burger','cheeseburger','meat loaf'], label: 'Burger', kcal: 350 },
{ keys: ['hotdog','hot dog'], label: 'Hot Dog', kcal: 150 },
{ keys: ['french fries','fries'], label: 'French Fries', kcal: 365 },
{ keys: ['apple'], label: 'Apple', kcal: 95 },
{ keys: ['banana'], label: 'Banana', kcal: 105 },
{ keys: ['orange'], label: 'Orange', kcal: 62 },
{ keys: ['broccoli'], label: 'Broccoli', kcal: 55 },
{ keys: ['carrot'], label: 'Carrot', kcal: 41 }
];

function estimateCaloriesFromLabel(label) {
const l = label.toLowerCase();
for (const item of CAL_DB) {
if (item.keys.some(k => l.includes(k))) return item;
}
return null;
}

// --- Load MobileNet model ---
(async () => {
model = await mobilenet.load();
modelReady = true;
calorieResult.textContent = "‚úÖ Model loaded. Ready!";
})();

// --- Start / stop camera ---
startButton.addEventListener('click', () => {
if (!videoStreamActive) {
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
.then(s => {
stream = s;
video.srcObject = stream;
startButton.textContent = 'Turn Camera Off';
zoomInButton.disabled = false;
zoomOutButton.disabled = false;
captureButton.disabled = false;
switchViewButton.disabled = false;
videoStreamActive = true;
})
.catch(err => alert("Error accessing camera: " + err));
} else {
stream.getTracks().forEach(track => track.stop());
startButton.textContent = 'Turn Camera On';
zoomInButton.disabled = true;
zoomOutButton.disabled = true;
captureButton.disabled = true;
switchViewButton.disabled = true;
videoStreamActive = false;
zoomLevel = 1;
video.style.transform = `scale(${zoomLevel})`;
}
});

// --- Zoom controls ---
zoomInButton.addEventListener('click', () => {
zoomLevel += 0.1;
video.style.transform = `scale(${zoomLevel})`;
});
zoomOutButton.addEventListener('click', () => {
if (zoomLevel > 0.2) {
zoomLevel -= 0.1;
video.style.transform = `scale(${zoomLevel})`;
}
});

// --- Capture & classify ---
captureButton.addEventListener('click', () => {
if (!videoStreamActive || !modelReady) return;
calorieResult.textContent = 'üîç Capturing and analyzing...';

const canvas = document.createElement('canvas');
canvas.width = video.videoWidth || 640;
canvas.height = video.videoHeight || 480;
canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
capturedImage.src = canvas.toDataURL('image/png');

// Wait until image loads before classification
capturedImage.onload = async () => {
try {
const predictions = await model.classify(capturedImage, 5);
console.log('Predictions:', predictions);

let mapped = estimateCaloriesFromLabel(predictions[0].className);
if (!mapped) {
for (let i = 1; i < predictions.length; i++) {
mapped = estimateCaloriesFromLabel(predictions[i].className);
if (mapped) break;
}
}

const top3 = predictions.slice(0,3)
.map(p => `${p.className} (${(p.probability*100).toFixed(1)}%)`)
.join(' ‚Ä¢ ');

if (mapped) {
calorieResult.innerHTML =
`‚úÖ <strong>${mapped.label}</strong> ‚âà <strong>${mapped.kcal} kcal</strong><br/>
<span style="font-size:.9em;color:#555">AI guesses: ${top3}</span>`;
} else {
calorieResult.innerHTML =
`‚ö†Ô∏è No calorie match found.<br/>
Top guesses: ${top3}`;
}
} catch (err) {
console.error(err);
calorieResult.textContent = '‚ùå Error during detection.';
}
};
});

// --- Switch view ---
switchViewButton.addEventListener('click', () => {
if (currentView === 'video') {
video.style.display = 'none';
capturedImage.style.display = 'block';
switchViewButton.textContent = 'Switch to Video';
currentView = 'image';
} else {
capturedImage.style.display = 'none';
video.style.display = 'block';
switchViewButton.textContent = 'Switch to Image';
currentView = 'video';
}
});
</script>
</body>
</html>