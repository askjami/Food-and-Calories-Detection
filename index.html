<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blind Audio Guide App</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body {
      background-color: black;
      color: white;
      text-align: center;
      font-size: 18px;
      margin: 0;
      padding: 0;
    }
    video, canvas {
      display: none; /* Hide visuals for blind-friendly mode */
    }
    #status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 22px;
      text-align: center;
    }
  </style>
</head>
<body>
  <p id="status">Tap anywhere to begin audio guide.</p>
  <video id="webcam" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');

    let model;
    const recentDetections = {};
    const SPEAK_DELAY = 5000;

    const foodCalories = {
      'apple': 95, 'banana': 105, 'orange': 62, 'carrot': 25, 'broccoli': 55, 'cake': 235,
      'donut': 195, 'hot dog': 150, 'pizza': 285, 'sandwich': 300, 'sandwiches': 300,
      'cupcake': 200, 'bread': 80, 'egg': 78, 'cheese': 113, 'hamburger': 250,
      'chocolate': 210, 'ice cream': 137, 'avocado': 160, 'strawberry': 4, 'blueberry': 1,
      'grape': 2, 'pineapple': 50, 'mango': 99, 'pear': 100, 'kiwi': 42, 'cucumber': 16,
      'tomato': 22, 'pepper': 20, 'lettuce': 5, 'corn': 88, 'onion': 40, 'garlic': 5,
      'potato': 163, 'peach': 59, 'plum': 30, 'watermelon': 85, 'rice': 206, 'pasta': 221,
      'milk': 103
    };

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve(video);
      });
    }

    async function detectFrame() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const predictions = await model.detect(video);
      const now = Date.now();

      predictions.forEach(pred => {
        const label = pred.class.toLowerCase();

        if (!recentDetections[label] || now - recentDetections[label] > SPEAK_DELAY) {
          recentDetections[label] = now;

          if (foodCalories[label]) {
            speak(`Detected ${label}. Estimated calories: ${foodCalories[label]}`);
          } else {
            speak(`Detected ${label}`);
          }
        }
      });

      requestAnimationFrame(detectFrame);
    }

    async function startApp() {
      speak("Welcome to the blind guide app. Initializing camera.");
      statusText.innerText = "Loading model and camera. Please wait...";

      try {
        await setupCamera();
        video.play();
        model = await cocoSsd.load();
        speak("Model loaded. Starting object and food detection.");
        statusText.innerText = "Running detection...";

        detectFrame();
      } catch (error) {
        speak("Camera access failed. Please check permissions.");
        statusText.innerText = "Camera access failed.";
        console.error(error);
      }
    }

    // Start app on user interaction (tap/click)
    document.body.addEventListener('click', () => {
      startApp();
    }, { once: true });

    // Optionally add keyboard start for screen readers
    document.body.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        startApp();
      }
    }, { once: true });
  </script>
</body>
</html>
