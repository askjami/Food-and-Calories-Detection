<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blind Guide + Food & Object Detection with Calories - Version 8</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    video, canvas {
      width: 100%;
      max-width: 600px;
      border: 1px solid black;
      margin-bottom: 10px;
    }
    #controls button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 1em;
    }
    #calorieResult {
      margin-top: 20px;
      font-size: 1.1em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ü¶Ø Blind Guide + üçΩÔ∏è Food & Object Detection <br><small>Version 8</small></h1>

  <div id="controls">
    <button id="startButton">Turn Camera On</button>
    <button id="captureButton" disabled>Capture & Detect</button>
    <button id="speakButton" disabled>üîä Speak Results</button>
  </div>

  <video id="video" autoplay muted></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <p id="calorieResult">Loading model, please wait‚Ä¶</p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');
    const captureButton = document.getElementById('captureButton');
    const speakButton = document.getElementById('speakButton');
    const calorieResult = document.getElementById('calorieResult');

    let stream;
    let model;
    let modelReady = false;
    let videoStreamActive = false;

    let lastSpokenText = ''; // For voice output

    const CAL_DB = {
      apple: 95, banana: 105, orange: 62, grape: 62, watermelon: 85, pineapple: 82,
      mango: 201, strawberry: 50, blueberry: 85, pear: 102, peach: 58, plum: 30,
      cherry: 77, avocado: 240, tomato: 22, cucumber: 16, carrot: 41, broccoli: 55,
      spinach: 23, potato: 161, sweetpotato: 180, corn: 96, rice: 206, pasta: 221,
      bread: 80, sandwich: 300, pizza: 285, hamburger: 350, hotdog: 150, fries: 365,
      egg: 78, chicken: 335, beef: 250, fish: 200, donut: 195, cake: 340,
      cookie: 160, milk: 122, cheese: 113, yogurt: 150
    };

    function normalizeLabel(label) {
      return label.toLowerCase().replace(/[\s_-]/g, "");
    }

    // --- Load COCO-SSD Model ---
    (async () => {
      model = await cocoSsd.load();
      modelReady = true;
      calorieResult.textContent = "‚úÖ Model loaded. Ready!";
    })();

    // --- Camera Toggle ---
    startButton.addEventListener('click', () => {
      if (!videoStreamActive) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(s => {
            stream = s;
            video.srcObject = stream;
            startButton.textContent = 'Turn Camera Off';
            captureButton.disabled = false;
            videoStreamActive = true;
          })
          .catch(err => alert("Error accessing camera: " + err));
      } else {
        stream.getTracks().forEach(track => track.stop());
        startButton.textContent = 'Turn Camera On';
        captureButton.disabled = true;
        speakButton.disabled = true;
        videoStreamActive = false;
      }
    });

    // --- Capture and Detect ---
    captureButton.addEventListener('click', async () => {
      if (!videoStreamActive || !modelReady) return;
      calorieResult.textContent = "üîç Detecting...";

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const predictions = await model.detect(canvas);
      console.log(predictions);

      ctx.lineWidth = 3;
      ctx.font = "16px Arial";
      ctx.textBaseline = "top";

      let totalCalories = 0;
      let foodBreakdown = [];
      let allDetections = [];

      predictions.forEach(p => {
        const normalized = normalizeLabel(p.class);
        const isFood = CAL_DB.hasOwnProperty(normalized);
        const cal = isFood ? CAL_DB[normalized] : null;

        ctx.strokeStyle = isFood ? "green" : "red";
        ctx.fillStyle = isFood ? "green" : "red";
        ctx.strokeRect(...p.bbox);
        ctx.fillText(`${p.class} ${Math.round(p.score * 100)}%`, p.bbox[0], p.bbox[1]);

        allDetections.push(p.class);

        if (cal) {
          totalCalories += cal;
          foodBreakdown.push(`${p.class} ‚âà ${cal} calories`);
        }
      });

      let resultHTML = `üîé Detected objects: ${[...new Set(allDetections)].join(", ")}<br><br>`;
      let speakOutput = `Detected: ${[...new Set(allDetections)].join(", ")}. `;

      if (foodBreakdown.length > 0) {
        resultHTML += `‚úÖ Detected food items:<br>${foodBreakdown.join("<br>")}<br><br><strong>Total ‚âà ${totalCalories} calories</strong>`;
        speakOutput += `Calories detected. ${foodBreakdown.join(". ")}. Total approximately ${totalCalories} calories.`;
      } else {
        resultHTML += "‚ö†Ô∏è No known foods detected in calorie database.";
        speakOutput += "No food items found in calorie database.";
      }

      calorieResult.innerHTML = resultHTML;
      lastSpokenText = speakOutput;
      speakButton.disabled = false;
      canvas.style.display = "block";
    });

    // --- Text-to-Speech for Accessibility ---
    speakButton.addEventListener('click', () => {
      if (!lastSpokenText) return;
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(lastSpokenText);
      utter.lang = "en-US";
      utter.rate = 1;
      synth.cancel(); // Stop ongoing speech if any
      synth.speak(utter);
    });
  </script>
</body>
</html>
