<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blind Guide + Food & Object Detection â€” Version 9</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    video, canvas {
      width: 100%;
      max-width: 600px;
      border: 1px solid #444;
      margin-bottom: 10px;
    }
    #controls button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 1em;
    }
    #status {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ðŸ¦¯ Real-Time Food & Object Detection<br><small>With Calories & Audio â€” Version 9</small></h1>
  
  <div id="controls">
    <button id="startButton">Turn Camera On</button>
    <button id="muteButton" disabled>ðŸ”Š Mute</button>
  </div>

  <video id="video" autoplay muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="status">Loading model, please waitâ€¦</div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');
    const muteButton = document.getElementById('muteButton');
    const status = document.getElementById('status');

    let model, stream, isMuted = false, modelReady = false;
    let lastSpoken = 0;

    // Food calorie database
    const CAL_DB = {
      apple: 95, banana: 105, orange: 62, grape: 62, watermelon: 85, pineapple: 82,
      mango: 201, strawberry: 50, blueberry: 85, pear: 102, peach: 58, plum: 30,
      cherry: 77, avocado: 240, tomato: 22, cucumber: 16, carrot: 41, broccoli: 55,
      spinach: 23, potato: 161, sweetpotato: 180, corn: 96, rice: 206, pasta: 221,
      bread: 80, sandwich: 300, pizza: 285, hamburger: 350, hotdog: 150, fries: 365,
      egg: 78, chicken: 335, beef: 250, fish: 200, donut: 195, cake: 340,
      cookie: 160, milk: 122, cheese: 113, yogurt: 150
    };

    function normalizeLabel(label) {
      return label.toLowerCase().replace(/[\s_-]/g, "");
    }

    // Load model
    (async () => {
      model = await cocoSsd.load();
      modelReady = true;
      status.textContent = "âœ… Model loaded. Press 'Turn Camera On'";
    })();

    // Start/Stop camera
    startButton.onclick = async () => {
      if (!stream) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          video.srcObject = stream;
          startButton.textContent = "Turn Camera Off";
          muteButton.disabled = false;
          runRealtimeDetection();
        } catch (err) {
          alert("Error accessing camera: " + err.message);
        }
      } else {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        startButton.textContent = "Turn Camera On";
        muteButton.disabled = true;
        status.textContent = "Camera turned off.";
      }
    };

    // Toggle speech
    muteButton.onclick = () => {
      isMuted = !isMuted;
      muteButton.textContent = isMuted ? "ðŸ”‡ Unmute" : "ðŸ”Š Mute";
    };

    // Real-time detection
    async function runRealtimeDetection() {
      canvas.style.display = "none";
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (modelReady && stream) {
        const predictions = await model.detect(canvas);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 3;
        ctx.font = "16px Arial";

        const detected = {};
        let totalCalories = 0;
        let foodItems = [];

        predictions.forEach(p => {
          const label = normalizeLabel(p.class);
          const isFood = CAL_DB.hasOwnProperty(label);
          const cal = isFood ? CAL_DB[label] : null;

          ctx.strokeStyle = isFood ? "green" : "red";
          ctx.fillStyle = isFood ? "green" : "red";
          ctx.strokeRect(...p.bbox);
          ctx.fillText(`${p.class} ${Math.round(p.score * 100)}%`, p.bbox[0], p.bbox[1]);

          detected[p.class] = true;

          if (cal) {
            totalCalories += cal;
            foodItems.push(`${p.class} (${cal} kcal)`);
          }
        });

        const objectList = Object.keys(detected).join(", ");
        let summary = `Detected: ${objectList}`;
        if (foodItems.length > 0) {
          summary += `<br>Food items: ${foodItems.join(", ")}`;
          summary += `<br><strong>Total â‰ˆ ${totalCalories} kcal</strong>`;
        }

        status.innerHTML = summary;

        const now = Date.now();
        if (!isMuted && now - lastSpoken > 3000 && objectList) {
          lastSpoken = now;
          let spokenText = `Detected: ${objectList}.`;
          if (foodItems.length > 0) {
            spokenText += ` Food: ${foodItems.join(", ")}. Total about ${totalCalories} calories.`;
          }
          const utter = new SpeechSynthesisUtterance(spokenText);
          window.speechSynthesis.cancel(); // cancel previous
          window.speechSynthesis.speak(utter);
        }
      }

      if (stream) requestAnimationFrame(runRealtimeDetection);
    }
  </script>
</body>
</html>
