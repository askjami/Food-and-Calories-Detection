<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Food Calorie Detection v6</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<style>
body {
font-family: Arial, sans-serif;
text-align: center;
margin: 20px;
}
video, canvas {
width: 100%;
max-width: 600px;
border: 1px solid black;
margin-bottom: 10px;
}
#controls button {
margin: 5px;
padding: 10px 15px;
font-size: 1em;
}
#calorieResult {
margin-top: 20px;
font-size: 1.1em;
font-weight: bold;
}
</style>
</head>
<body>
<h1>üçΩÔ∏è Food Calorie Detection</h1>

<div id="controls">
<button id="startButton">Turn Camera On</button>
<button id="captureButton" disabled>Capture & Detect</button>
</div>

<video id="video" autoplay muted></video>
<canvas id="canvas" style="display:none;"></canvas>

<p id="calorieResult">Loading model, please wait‚Ä¶</p>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startButton = document.getElementById('startButton');
const captureButton = document.getElementById('captureButton');
const calorieResult = document.getElementById('calorieResult');

let stream;
let model;
let modelReady = false;
let videoStreamActive = false;

// --- Small calorie database (expandable) ---
const CAL_DB = {
apple: 95,
banana: 105,
orange: 62,
broccoli: 55,
carrot: 41,
pizza: 285,
sandwich: 300,
donut: 195,
cake: 340,
hotdog: 150,
hamburger: 350,
fries: 365,
};

// --- Load Coco-SSD ---
(async () => {
model = await cocoSsd.load();
modelReady = true;
calorieResult.textContent = "‚úÖ Model loaded. Ready!";
})();

// --- Start / stop camera ---
startButton.addEventListener('click', () => {
if (!videoStreamActive) {
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
.then(s => {
stream = s;
video.srcObject = stream;
startButton.textContent = 'Turn Camera Off';
captureButton.disabled = false;
videoStreamActive = true;
})
.catch(err => alert("Error accessing camera: " + err));
} else {
stream.getTracks().forEach(track => track.stop());
startButton.textContent = 'Turn Camera On';
captureButton.disabled = true;
videoStreamActive = false;
}
});

// --- Capture and run detection ---
captureButton.addEventListener('click', async () => {
if (!videoStreamActive || !modelReady) return;
calorieResult.textContent = "üîç Detecting foods...";

// Draw current video frame onto canvas
canvas.width = video.videoWidth;
canvas.height = video.videoHeight;
ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

// Run detection
const predictions = await model.detect(canvas);
console.log(predictions);

// Draw bounding boxes
ctx.lineWidth = 3;
ctx.font = "16px Arial";
predictions.forEach(p => {
ctx.strokeStyle = "red";
ctx.fillStyle = "red";
ctx.strokeRect(...p.bbox);
ctx.fillText(p.class + " " + Math.round(p.score*100)+"%", p.bbox[0], p.bbox[1] > 20 ? p.bbox[1]-5 : 10);
});

// Map to calories
let totalCalories = 0;
let breakdown = [];
predictions.forEach(p => {
const food = p.class.toLowerCase();
if (CAL_DB[food]) {
totalCalories += CAL_DB[food];
breakdown.push(`${p.class} ‚âà ${CAL_DB[food]} kcal`);
}
});

if (breakdown.length > 0) {
calorieResult.innerHTML =
`‚úÖ Detected foods:<br>${breakdown.join("<br>")}<br><br><strong>Total ‚âà ${totalCalories} kcal</strong>`;
} else {
calorieResult.textContent = "‚ö†Ô∏è No known foods detected.";
}

// Show canvas with annotations
canvas.style.display = "block";
});
</script>
</body>
</html>